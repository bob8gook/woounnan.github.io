

# 선행지식

### 취약점 및 힙의 변화를 잘 설명한 포스트

[devel0pment.de](https://devel0pment.de/?p=688)



### Off-by-one

길이 검사를 잘못하여 1바이트의 overflow가 생기는 취약점

```c
#include <stdio.h>
 
int main(int argc,char *argv[])
{
    char buf[512];
    
    if(strlen(argv[1]) > 512) {
        printf("prevented oversize\n");
        return -1;
    }
    
    strcpy(buf, argv[1]);
 
    return 0;
}

```



### Poison Null Byte

- 정의

  - Offy-by-one을 이용하여 기존의 heap 영역에 overflow를 일으킬 수 있음

- 이해

  1. `o1`, `b1`(size: 0x200), `a1` 청크를 연속으로 할당함

     - `o1`, b1 과 a1이 힙 영역에서 이어져야 함

  2. `b1`의 0x200 - 0x10 위치에 fake_prev_size인 0x200을 저장 

  3. `o1`을 Off 

  4. `b1`을 free

  5. `a1`의 `header ::: prev_size` 값이  0x210으로 수정됨

     *※추가된 0x10은 헤더의 크기※*

  6. 새로운 `new_b1`(size: 0x100)을 할당함

     *※기존 `b1`의 위치에 할당됨※*

  7. `new_b1`의 0x

- 실습

  - 문제생김

    - b1(이전 chunk)을 free를 했는데 a1(다음 chunk)의 prev_size가 변하지 않음

    - 실습은 보류...

      ```shell
      
      R10: 0x555555556027 --> 0x31b01000000000a
      R11: 0x246
      R12: 0x555555555080 (<_start>:  xor    ebp,ebp)
      R13: 0x7fffffffe440 --> 0x1
      R14: 0x0
      R15: 0x0
      EFLAGS: 0x206 (carry PARITY adjust zero sign trap INTERRUPT direction overflow)
      [-------------------------------------code-------------------------------------]
         0x555555555202 <main+157>:   mov    rax,QWORD PTR [rbp-0x10]
         0x555555555206 <main+161>:   mov    rdi,rax
         0x555555555209 <main+164>:   call   0x555555555030 <free@plt>
      => 0x55555555520e <main+169>:   mov    rax,QWORD PTR [rbp-0x8]
         0x555555555212 <main+173>:   sub    rax,0x40
         0x555555555216 <main+177>:   mov    eax,DWORD PTR [rax]
         0x555555555218 <main+179>:   mov    esi,eax
         0x55555555521a <main+181>:   lea    rdi,[rip+0xdf3]        # 0x555555556014
      [------------------------------------stack-------------------------------------]
      0000| 0x7fffffffe350 --> 0x555555559260 --> 0x0
      0008| 0x7fffffffe358 --> 0x555555559470 ('a' <repeats 80 times>)
      0016| 0x7fffffffe360 --> 0x555555555240 (<__libc_csu_init>:     push   r15)
      0024| 0x7fffffffe368 --> 0x7ffff7def09b (<__libc_start_main+235>:       mov    edi,eax)
      0032| 0x7fffffffe370 --> 0x0
      0040| 0x7fffffffe378 --> 0x7fffffffe448 --> 0x7fffffffe6b8 ("/work/pico2019/Ghost_Diary/poc")
      0048| 0x7fffffffe380 --> 0x100040000
      0056| 0x7fffffffe388 --> 0x555555555165 (<main>:        push   rbp)
      [------------------------------------------------------------------------------]
      Legend: code, data, rodata, value
      0x000055555555520e in main ()
      gdb-peda$ x/50wx $1-0x10
      0x555555559250: 0x00000000      0x00000000      0x00000211      0x00000000
      0x555555559260: 0x00000000      0x00000000      0x62626262      0x62626262
      0x555555559270: 0x62626262      0x62626262      0x62626262      0x62626262
      0x555555559280: 0x62626262      0x62626262      0x62626262      0x62626262
      0x555555559290: 0x62626262      0x62626262      0x62626262      0x62626262
      0x5555555592a0: 0x62626262      0x62626262      0x62626262      0x62626262
      0x5555555592b0: 0x62626262      0x62626262      0x62626262      0x62626262
      0x5555555592c0: 0x62626262      0x62626262      0x62626262      0x62626262
      0x5555555592d0: 0x62626262      0x62626262      0x62626262      0x62626262
      0x5555555592e0: 0x62626262      0x62626262      0x62626262      0x62626262
      0x5555555592f0: 0x62626262      0x62626262      0x62626262      0x62626262
      0x555555559300: 0x62626262      0x62626262      0x62626262      0x62626262
      0x555555559310: 0x62626262      0x62626262
      gdb-peda$ x/50wx $1+0x200
      0x555555559460: 0x00000000      0x00000000      0x00000061      0x00000000
      0x555555559470: 0x61616161      0x61616161      0x61616161      0x61616161
      0x555555559480: 0x61616161      0x61616161      0x61616161      0x61616161
      0x555555559490: 0x61616161      0x61616161      0x61616161      0x61616161
      0x5555555594a0: 0x61616161      0x61616161      0x61616161      0x61616161
      0x5555555594b0: 0x61616161      0x61616161      0x61616161      0x61616161
      0x5555555594c0: 0x00000000      0x00000000      0x00000411      0x00000000
      0x5555555594d0: 0x3a3a3161      0x6572703a      0x69735f76      0x3a20657a
      0x5555555594e0: 0x36323620      0x36323632      0x00000a32      0x00000000
      0x5555555594f0: 0x00000000      0x00000000      0x00000000      0x00000000
      0x555555559500: 0x00000000      0x00000000      0x00000000      0x00000000
      0x555555559510: 0x00000000      0x00000000      0x00000000      0x00000000
      0x555555559520: 0x00000000      0x00000000
      gdb-peda$
      ```

      

- 참조
  - [hansoo](https://code1018.tistory.com/220)
  - [bach](https://bachs.tistory.com/entry/how2heap-Poison-NULL-Byte)
  - [devel0pment](https://devel0pment.de/?p=688)
  - 